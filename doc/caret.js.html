<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pwk/editor/layer/caret.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: pwk/editor/layer/caret.js</h1>





    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//
// Pubwebkit editor is powerful editor to create your ebook in various styles.
// It's includes: Cover Designer, Template Editor, Community Snippets and more...
// Also, it's a part of www.pubwebkit.com portal.
// Copyright (C) 2014 Dmytro Antonenko
//
// This file is part of Pubwebkit editor
//
// Pubwebkit editor is free software: you can redistribute it and/or modify it under
// the terms of the GNU Affero General Public License as published by the Free
// Software Foundation, version 3
//
// Pubwebkit editor is distributed in the hope that it will be useful, but WITHOUT ANY
// WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
// FOR A PARTICULAR PURPOSE.
//
// See the GNU Affero General Public License for more details. You should have received
// a copy of the GNU General Public License along with Hatch.js. If not, see
// &lt;http://www.gnu.org/licenses/>.
//
// Authors: Dmytro Antonenko
//

/**
 * @fileoverview Component that represent caret in document
 * @author Dmytro Antonenko &lt;dmitry.antonenko@pubwebkit.com>
 */

goog.provide('pwk.layer.Caret');
goog.provide('pwk.layer.Caret.AfterUpdateEvent');

goog.require('pwk.utils.dom');
goog.require('goog.dom.classlist');
goog.require('goog.ui.Component');
goog.require('goog.dom.Range');
goog.require('goog.editor.range');
goog.require('goog.style');
goog.require('goog.events.Event');

/**
 * Initialize {pwk.layer.Caret} component.
 *
 * @param {goog.dom.DomHelper=} opt_domHelper Optional DOM helper, used for document interaction.
 * @constructor
 * @extends {goog.ui.Component}
 */
pwk.layer.Caret = function(opt_domHelper) {
    goog.base(this, opt_domHelper);

    /**
     * Is cursor visible.
     *
     * @type {boolean}
     * @private
     */
    this.isVisible_ = false;

    /**
     * Parent caret wrapper.
     *
     * @type {Node}
     * @private
     */
    this.layer_;

    /**
     * @type {number}
     * @private
     */
    this.blinkId_;

    /**
     * @type {Element}
     * @private
     */
    this.documentElement_;

    /**
     * A zero width space character.
     * @type {string}
     * @private
     */
    this.ZERO_WIDTH_SPACE_ = '\ufeff';

    this.count_ = 0;
};
goog.inherits(pwk.layer.Caret, goog.ui.Component);


/**
 * Default CSS class to be applied to the root element of components rendered
 * by this renderer.
 *
 * @type {string}
 */
pwk.layer.Caret.CSS_CLASS = 'pwk-caret';

/**
 * CSS class of parent caret wrapper element.
 *
 * @type {string}
 */
pwk.layer.Caret.CSS_CLASS_LAYER = 'pwk-caret-layer';


/** @inheritDoc */
pwk.layer.Caret.prototype.createDom = function() {
    var element = goog.dom.createDom('div');

    this.documentElement_ = goog.dom.getElementByClass(pwk.Document.CSS_CLASS);

    goog.style.setUnselectable(element, true);

    this.setElementInternal(element);
    this.decorateInternal(element);
};


/** @inheritDoc */
pwk.layer.Caret.prototype.decorateInternal = function(element) {
    goog.base(this, 'decorateInternal', element);

    // Add css class
    goog.dom.classlist.add(element, pwk.layer.Caret.CSS_CLASS);

    // Initialize wrapper
    this.layer_ = goog.dom.createDom('div');
    goog.dom.classlist.add(this.layer_, pwk.layer.Caret.CSS_CLASS_LAYER);
};


pwk.layer.Caret.prototype.enterDocument = function() {
    goog.base(this, 'enterDocument');

    // Wrap by layer
    var parent = /** @type {!Node} */(goog.dom.getParentElement(this.getElement()));
    goog.dom.append(parent, this.layer_);
    this.layer_.appendChild(this.getElement());

    // Initialize events
    this.listen(pwk.layer.Caret.EventType.BEFORE_UPDATE, this.onCaretBeforeUpdate_, false, this);
    this.listen(pwk.layer.Caret.EventType.AFTER_UPDATE, this.onCaretAfterUpdate_, false, this);
};


/** @inheritDoc */
pwk.layer.Caret.prototype.disposeInternal = function() {
    goog.base(this, 'disposeInternal');

    // Stop timer
    clearInterval(this.blinkId_);

    // Remove DOM nodes
    if(this.layer_) {
        goog.dom.removeNode(this.layer_);
    }
    delete this.layer_;

    // Remove references to DOM nodes,
    this.documentElement_ = null;

    //NOTE: Event listeners are cleaned in the method exitDocument of base class
};


/**
 * Hide cursor.
 */
pwk.layer.Caret.prototype.hide = function() {
    var el = this.getElement();

    clearInterval(this.blinkId_);
    this.isVisible_ = false;
    el.style.visibility = "hidden";
};


/**
 * Show cursor.
 */
pwk.layer.Caret.prototype.show = function() {
    var el = this.getElement();

    this.isVisible_ = true;
    el.style.visibility = "visible";
    this.restartTimer();
};


/**
 * Restart blink
 */
pwk.layer.Caret.prototype.restartTimer = function() {
    clearInterval(this.blinkId_);
    if (!this.isVisible_) {
        return;
    }

    var self = this.getElement()
      , obj = this;
    this.blinkId_ = setInterval(function() {
        self.style.visibility = "hidden";
        setTimeout(function() {
            if(obj.isVisible_) {
                self.style.visibility = "visible";
            }
        }, 400);
    }, 1000);
};


/**
 * Update cursor position by range
 *
 * @param {pwk.Selection} selection
 * @return {goog.math.Rect}
 */
pwk.layer.Caret.prototype.update = function(selection) {

    this.dispatchEvent(pwk.layer.Caret.EventType.BEFORE_UPDATE);

	var el = this.getElement()
      , bounds = selection.getBoundsForRange()
      , elStyle = el.style

    elStyle.left = bounds.left + 'px';
    elStyle.top = bounds.top + 'px';
    elStyle.height = bounds.height + 'px';

    this.restartTimer();
    this.dispatchEvent(new pwk.layer.Caret.AfterUpdateEvent(this, bounds));

    return bounds;
};


/**
 * @param {goog.events.Event} e
 * @private
 */
pwk.layer.Caret.prototype.onCaretBeforeUpdate_ = function(e) {
};


/**
 * @param {pwk.layer.Caret.AfterUpdateEvent} e
 * @private
 */
pwk.layer.Caret.prototype.onCaretAfterUpdate_ = function(e) {

};


/**
 * @enum {string}
 */
pwk.layer.Caret.EventType = {
    BEFORE_UPDATE: goog.events.getUniqueId('before_update'),
    AFTER_UPDATE: goog.events.getUniqueId('after_update')
};


/**
 * @param {pwk.layer.Caret} caret
 * @param {goog.math.Rect} bounds
 * @constructor
 * @extends {goog.events.Event}
 */
pwk.layer.Caret.AfterUpdateEvent = function(caret, bounds) {
    goog.events.Event.call(this, pwk.layer.Caret.EventType.AFTER_UPDATE, caret);

    /**
     * @type {goog.math.Rect}
     * @private
     */
    this.bounds_ = bounds;
};
goog.inherits(pwk.layer.Caret.AfterUpdateEvent, goog.events.Event);


/**
 * @return {goog.math.Rect}
 */
pwk.layer.Caret.AfterUpdateEvent.prototype.getBounds = function() {
    return this.bounds_;
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="app.controllers.HomeController.html">HomeController</a></li><li><a href="app.Core.html">Core</a></li><li><a href="app.core.Application.html">Application</a></li><li><a href="app.core.Application_processRoute_-instance.html">instance</a></li><li><a href="app.core.Controller.html">Controller</a></li><li><a href="app.core.events.ActionEvent.html">ActionEvent</a></li><li><a href="app.core.events.ActionExceptionEvent.html">ActionExceptionEvent</a></li><li><a href="app.core.Request.html">Request</a></li><li><a href="app.core.Response.html">Response</a></li><li><a href="app.core.Router.html">Router</a></li><li><a href="app.core.types.ActionFilterContext.html">ActionFilterContext</a></li><li><a href="app.core.types.ActionFilterItem.html">ActionFilterItem</a></li><li><a href="app.core.types.ApplicationFilterItem.html">ApplicationFilterItem</a></li><li><a href="pwk.BranchNode.html">BranchNode</a></li><li><a href="pwk.Document.html">Document</a></li><li><a href="pwk.Document.NodeRemovedEvent.html">NodeRemovedEvent</a></li><li><a href="pwk.DocumentSettings.html">DocumentSettings</a></li><li><a href="pwk.Editor.html">Editor</a></li><li><a href="pwk.EditorContainer.html">EditorContainer</a></li><li><a href="pwk.layer.Caret.html">Caret</a></li><li><a href="pwk.layer.Caret.AfterUpdateEvent.html">AfterUpdateEvent</a></li><li><a href="pwk.layer.SelectionOverlay.html">SelectionOverlay</a></li><li><a href="pwk.LeafNode.html">LeafNode</a></li><li><a href="pwk.LeafNode.NodeContentChangedEvent.html">NodeContentChangedEvent</a></li><li><a href="pwk.Line.html">Line</a></li><li><a href="pwk.LineContent.html">LineContent</a></li><li><a href="pwk.Node.html">Node</a></li><li><a href="pwk.NodeAnnotation.html">NodeAnnotation</a></li><li><a href="pwk.NodeAttribute.html">NodeAttribute</a></li><li><a href="pwk.Page.html">Page</a></li><li><a href="pwk.Page.PageOverflowEvent.html">PageOverflowEvent</a></li><li><a href="pwk.PageContent.html">PageContent</a></li><li><a href="pwk.PageFooter.html">PageFooter</a></li><li><a href="pwk.PageHeader.html">PageHeader</a></li><li><a href="pwk.PageSettings.html">PageSettings</a></li><li><a href="pwk.Pagination.html">Pagination</a></li><li><a href="pwk.primitives.ClientRectRange.html">ClientRectRange</a></li><li><a href="pwk.primitives.NodeSelectionRange.html">NodeSelectionRange</a></li><li><a href="pwk.Range.html">Range</a></li><li><a href="pwk.Ruler.html">Ruler</a></li><li><a href="pwk.Selection.html">Selection</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Tue Dec 30 2014 02:19:31 GMT+0200 (EET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
